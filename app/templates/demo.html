<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Demo Hệ Thống Ảnh</title>
    <style>
        body { 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
    margin: 0 auto; 
    padding: 20px;
    max-width: 1200px; 
    background-image: url('https://i.pinimg.com/736x/34/2d/65/342d65b69f785e734a177cb65701dd4b.jpg'); 
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: fixed; 
}


.main-header {
    position: relative; 
    text-align: center; 
    padding: 10px 0;
    margin-bottom: 20px; 
}
.main-header h1 {
    margin: 0;
    font-size: 2.2em; 
}
.main-header button {
    position: absolute; 
    top: 10px;
    right: 0;
}


.panel-row {
    display: flex; 
    gap: 20px; 
    margin-bottom: 20px; 
}
.panel-row .panel {
    flex: 1; 
    margin-bottom: 0; 
}


div.panel { 
    background: rgba(255, 255, 255, 0.2); /* Nền trắng, ĐỘ MỜ 20% */
    border: 1px solid rgba(255, 255, 255, 0.3); /* Viền hơi mờ */
    border-radius: 16px; /* Bo tròn góc nhiều hơn */
    padding: 20px; 
    margin-bottom: 20px; /* Khoảng cách cho panel 3 và 4 */
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); /* Bóng đổ mềm mại */
    backdrop-filter: blur(10px); /* LÀM MỜ NỀN PHÍA SAU KHUNG */
    -webkit-backdrop-filter: blur(10px); /* Hỗ trợ trình duyệt Webkit */
}


h2 { 
    border-bottom: 2px solid #eee; 
    padding-bottom: 5px; 
    margin-top: 0; 
    text-shadow: 0px 0px 5px rgba(0, 0, 0, 0.5); 
    color: white; 
}
input { 
    width: calc(100% - 20px); 
    padding: 8px; 
    margin-bottom: 10px; 
    display: block; 
    border: 1px solid #ddd; 
    border-radius: 5px; 
}
button { 
    padding: 10px 15px; 
    background: #007bff; 
    color: white; 
    border: none; 
    border-radius: 5px; 
    cursor: pointer; 
    margin-right: 5px; 
}
button:hover { background: #0056b3; }
button.danger { background: #dc3545; }
button.danger:hover { background: #c82333; }

pre { 
    background: #222; 
    color: #00ff00; 
    padding: 15px; 
    border-radius: 5px; 
    white-space: pre-wrap; 
    word-wrap: break-word; 
    max-height: 400px; 
    overflow-y: auto; 
}
#gallery { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
    gap: 10px; 
}
#gallery img { 
    width: 100%; 
    height: 150px; 
    object-fit: cover; 
    border-radius: 5px; 
    border: 2px solid #ddd; 
    cursor: pointer; 
}
    </style>
</head>
<body>

    <header class="main-header">
        <h1>Bảng Điều Khiển Demo</h1>
        <button onclick="logout()" class="danger">Đăng xuất</button>
    </header>

    <div class="panel-row">
        
        <div class="panel"> 
            <h2>1. Upload Ảnh (Cần Token)</h2>
            <input type="file" id="fileInput" accept="image/*">
            <button onclick="uploadImage()">Upload</button>
        </div>
    
        <div class="panel"> 
            <h2>2. Thư viện & Tìm kiếm (Cần Token)</h2>
            <button onclick="getMyImages()">Lấy Toàn Bộ Ảnh Của Tôi</button>
            <hr style="border:0; border-top: 1px solid #eee; margin: 15px 0;">
            <input type="text" id="tag" placeholder="Nhập tag (ví dụ: cat, dog, beach)...">
            <button onclick="searchByTag()">Tìm theo Tag</button>
        </div>

    </div> <div class="panel">
        <h2>Kết quả API (JSON)</h2>
        <pre id="responseOutput">Đang tải...</pre>
    </div>
    
    <div class="panel">
        <h2>Thư viện Ảnh</h2>
        <div id="gallery"></div>
    </div>
   <script>
    const API_URL = "http://127.0.0.1:5000";
    const output = document.getElementById('responseOutput');
    const gallery = document.getElementById('gallery');

    // TỰ ĐỘNG LẤY TOKEN TỪ TRÌNH DUYỆT
    let currentToken = localStorage.getItem('accessToken');

    // HÀM KIỂM TRA ĐĂNG NHẬP
    function checkLogin() {
        if (!currentToken) {
            alert('Bạn chưa đăng nhập! Đang chuyển về trang đăng nhập.');
            window.location.href = '/'; // Quay về trang chủ (login)
        } else {
            // Nếu đã đăng nhập, tự động lấy ảnh
            getMyImages();
        }
    }

    // Hàm Đăng xuất
    function logout() {
        localStorage.removeItem('accessToken'); // Xóa token
        window.location.href = '/'; // Quay về trang login
    }

    // --- SỬA HÀM NÀY ---
    // Hàm tiện ích để hiển thị thông báo
    function showResults(message, type = 'success') {
        output.textContent = message; // Chỉ hiển thị tin nhắn
        if (type === 'error') {
            output.style.color = '#ff4d4d'; // Màu đỏ cho lỗi
        } else {
            output.style.color = '#00ff00'; // Màu xanh cho thành công
        }
    }
    // --------------------

    // Hàm tiện ích để hiển thị ảnh trong thư viện
    function renderGallery(images) {
        gallery.innerHTML = "";
        if (!images || images.length === 0) {
            gallery.innerHTML = "<p>Không tìm thấy ảnh nào.</p>";
            return;
        }
        images.forEach(img => {
            const imgElement = document.createElement('img');
            imgElement.src = img.url;
            imgElement.title = `Tags: ${img.tags ? img.tags.join(', ') : 'N/A'}`;
            imgElement.onclick = () => {
                alert(`Ảnh ID: ${img.id}\nTags: ${img.tags ? img.tags.join(', ') : 'Chưa có tag'}`);
            };
            gallery.appendChild(imgElement);
        });
    }

    // --- HÀM UPLOAD (ĐÃ SỬA) ---
    async function uploadImage() {
        const fileInput = document.getElementById('fileInput');
        if (!currentToken || fileInput.files.length === 0) {
            showResults("❌ Lỗi: Vui lòng Chọn file!", 'error');
            return;
        }
        showResults("Đang upload và phân loại...");
        const formData = new FormData();
        formData.append('image', fileInput.files[0]);

        const res = await fetch(`${API_URL}/api/images/upload`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${currentToken}` },
            body: formData
        });
        const data = await res.json();

        if (res.ok) {
            // Tạo thông báo thành công
            const tagsText = data.tags ? data.tags.join(', ') : 'Không có';
            showResults(`✅ Upload thành công!\nẢnh ID: ${data.image_id}\nTags: [${tagsText}]`);
            getMyImages(); // Tự động làm mới thư viện
        } else {
            showResults(`❌ Lỗi Upload: ${data.msg}`, 'error');
        }
    }

    // --- HÀM LẤY ẢNH (ĐÃ SỬA) ---
    async function getMyImages() {
        if (!currentToken) return;
        showResults("Đang lấy ảnh của bạn...");
        const res = await fetch(`${API_URL}/api/images/my-images`, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${currentToken}` }
        });
        const data = await res.json();

        if (res.ok) {
            showResults(`✅ Tải thành công ${data.length} ảnh của bạn.`);
            renderGallery(data);
        } else {
            showResults(`❌ Lỗi: ${data.msg}`, 'error');
        }
    }

    // --- HÀM TÌM KIẾM (ĐÃ SỬA) ---
    async function searchByTag() {
        const tag = document.getElementById('tag').value;
        if (!currentToken || !tag) {
            showResults("❌ Lỗi: Vui lòng Nhập tag!", 'error');
            return;
        }
        showResults(`Đang tìm tag '${tag}'...`);
        const res = await fetch(`${API_URL}/api/images/search?tag=${tag}`, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${currentToken}` }
        });
        const data = await res.json();

        if (res.ok) {
            showResults(`✅ Tìm thấy ${data.length} ảnh với tag '${tag}'.`);
            renderGallery(data);
        } else {
            showResults(`❌ Lỗi: ${data.msg}`, 'error');
        }
    }

    // CHẠY KIỂM TRA ĐĂNG NHẬP KHI TẢI TRANG
    checkLogin();
</script>
</body>
</html>