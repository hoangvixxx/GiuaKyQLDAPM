<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Demo Hệ Thống Ảnh</title>
    <style>
        /* ======================================= */
        /* CSS CHO BỐ CỤC (LAYOUT) VÀ HIỆU ỨNG KÍNH MỜ */
        /* ======================================= */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0 auto; 
            padding: 20px;
            max-width: 1200px; 
            
            /* Background Ảnh Nền & Cố định */
            background-image: url('https://i.pinimg.com/736x/34/2d/65/342d65b69f785e734a177cb65701dd4b.jpg'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed; 
        }

        /* Header và Nút Đăng Xuất */
        .main-header {
            position: relative; 
            text-align: center; 
            padding: 10px 0;
            margin-bottom: 20px; 
        }
        .main-header h1 {
            margin: 0;
            font-size: 2.2em; 
            text-shadow: 0px 0px 8px rgba(0, 0, 0, 0.7); /* Thêm bóng đổ cho chữ header */
            color: white; 
        }
        .main-header button {
            position: absolute; 
            top: 10px;
            right: 0;
        }

        /* --------------------------------- */
        /* KHUNG CHỨA (MỜ MỜ) VÀ BỐ CỤC CHÍNH */
        /* --------------------------------- */
        .panel-row {
            display: flex; 
            gap: 20px; 
            margin-bottom: 20px; 
        }
        .panel-row .panel {
            flex: 1; 
            margin-bottom: 0; 
        }

        /* Hiệu ứng Kính Mờ (Glass Blur) */
        div.panel { 
            background: rgba(255, 255, 255, 0.2); /* Nền trắng, ĐỘ MỜ 20% */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Viền hơi mờ */
            border-radius: 16px; 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); 
            backdrop-filter: blur(10px); /* LÀM MỜ NỀN PHÍA SAU KHUNG */
            -webkit-backdrop-filter: blur(10px); 
        }

        /* Tiêu đề trong khung (cho dễ đọc) */
        h2 { 
            border-bottom: 2px solid rgba(255, 255, 255, 0.5); /* Viền dưới mờ */
            padding-bottom: 5px; 
            margin-top: 0; 
            text-shadow: 0px 0px 5px rgba(0, 0, 0, 0.5); 
            color: white; 
        }

        /* Input và Button (Chung) */
        input { 
            width: calc(100% - 20px); 
            padding: 8px; 
            margin-bottom: 10px; 
            display: block; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            background: rgba(255, 255, 255, 0.8); /* Input hơi mờ */
        }
        button { 
            padding: 10px 15px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin-right: 5px; 
        }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }

        /* Kết quả JSON (Hộp đen) */
        pre { 
            background: #222; 
            color: #00ff00; 
            padding: 15px; 
            border-radius: 5px; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            max-height: 400px; 
            overflow-y: auto; 
        }
        
        /* -------------------------------- */
        /* THƯ VIỆN ẢNH VÀ NÚT XÓA (MỚI) */
        /* -------------------------------- */
        #gallery { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 10px; 
        }
        .image-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            border: none;
            padding: 0;
            margin: 0;
        }
        #gallery img { 
            width: 100%; 
            height: 150px; 
            object-fit: cover; 
            border-radius: 5px; 
            border: 2px solid rgba(255, 255, 255, 0.5); /* Viền mờ */
            cursor: pointer; 
            margin-bottom: 5px; 
        }
        .delete-btn {
            width: 100%;
            font-size: 0.8em;
            padding: 5px;
            border-radius: 5px;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <header class="main-header">
        <h1>Bảng Điều Khiển Demo</h1>
        <button onclick="logout()" class="danger">Đăng xuất</button>
    </header>

    <div class="panel-row">
        
        <div class="panel"> 
            <h2>1. Upload Ảnh (Cần Token)</h2>
            <input type="file" id="fileInput" accept="image/*">
            <button onclick="uploadImage()">Upload</button>
        </div>
    
        <div class="panel"> 
            <h2>2. Thư viện & Tìm kiếm (Cần Token)</h2>
            <button onclick="getMyImages()">Lấy Toàn Bộ Ảnh Của Tôi</button>
            <hr style="border:0; border-top: 1px solid #eee; margin: 15px 0;">
            <input type="text" id="tag" placeholder="Nhập tag (ví dụ: cat, dog, beach)...">
            <button onclick="searchByTag()">Tìm theo Tag</button>
        </div>

    </div> 
    
    <div class="panel">
        <h2>Kết quả API (JSON)</h2>
        <pre id="responseOutput">Đang tải...</pre>
    </div>
    
    <div class="panel">
        <h2>Thư viện Ảnh</h2>
        <div id="gallery"></div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:5000";
        const output = document.getElementById('responseOutput');
        const gallery = document.getElementById('gallery');
        let currentToken = localStorage.getItem('accessToken');

        // Hàm kiểm tra đăng nhập & Đăng xuất
        function checkLogin() {
            if (!currentToken) {
                alert('Bạn chưa đăng nhập! Đang chuyển về trang đăng nhập.');
                window.location.href = '/'; 
            } else { getMyImages(); }
        }
        function logout() {
            localStorage.removeItem('accessToken');
            window.location.href = '/';
        }

        // Hàm hiển thị thông báo
        function showResults(message, type = 'success') {
            output.textContent = message;
            output.style.color = (type === 'error') ? '#ff4d4d' : (type === 'warning' ? '#ff9900' : '#00ff00');
        }

        // ===============================================
        // HÀM HIỂN THỊ ẢNH (ĐÃ THÊM NÚT XÓA)
        // ===============================================
        function renderGallery(images) {
            gallery.innerHTML = "";
            if (!images || images.length === 0) {
                gallery.innerHTML = "<p>Không tìm thấy ảnh nào.</p>";
                return;
            }
            images.forEach(img => {
                const card = document.createElement('div');
                card.className = 'image-card'; 
                
                // 1. Ảnh
                const imgElement = document.createElement('img');
                imgElement.src = img.url;
                imgElement.title = `Tags: ${img.tags ? img.tags.join(', ') : 'N/A'}`;
                imgElement.onclick = () => {
                    alert(`Ảnh ID: ${img.id}\nTags: ${img.tags ? img.tags.join(', ') : 'Chưa có tag'}`);
                };
                card.appendChild(imgElement);

                // 2. Nút Xóa
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '❌ Xóa';
                deleteBtn.className = 'delete-btn danger';
                deleteBtn.onclick = () => {
                    deleteImage(img.id); // Gọi hàm xóa ảnh
                };
                card.appendChild(deleteBtn);

                gallery.appendChild(card);
            });
        }

        // ===============================================
        // HÀM XÓA ẢNH MỚI (DELETE)
        // ===============================================
        async function deleteImage(imageId) {
            if (!confirm('BẠN CÓ CHẮC CHẮN MUỐN XÓA ẢNH NÀY KHÔNG? Hành động này không thể hoàn tác!')) {
                return;
            }

            showResults(`Đang xóa ảnh ID ${imageId}...`, 'warning');
            
            const res = await fetch(`${API_URL}/api/images/${imageId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${currentToken}` }
            });
            
            const data = await res.json();

            if (res.ok) {
                showResults(`✅ ${data.msg}`, 'success');
                getMyImages(); // Tải lại thư viện
            } else {
                showResults(`❌ Lỗi xóa: ${data.msg}`, 'error');
            }
        }


        // --- CÁC HÀM CŨ (LOGIC) ---

        async function uploadImage() {
            const fileInput = document.getElementById('fileInput');
            if (!currentToken || fileInput.files.length === 0) {
                showResults("❌ Lỗi: Vui lòng Chọn file!", 'error');
                return;
            }
            showResults("Đang upload và phân loại...");
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);

            const res = await fetch(`${API_URL}/api/images/upload`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${currentToken}` },
                body: formData
            });
            const data = await res.json();

            if (res.ok) {
                const tagsText = data.tags ? data.tags.join(', ') : 'Không có';
                showResults(`✅ Upload thành công!\nẢnh ID: ${data.image_id}\nTags: [${tagsText}]`);
                getMyImages(); 
            } else {
                showResults(`❌ Lỗi Upload: ${data.msg}`, 'error');
            }
        }

        async function getMyImages() {
            if (!currentToken) return;
            showResults("Đang lấy ảnh của bạn...");
            const res = await fetch(`${API_URL}/api/images/my-images`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${currentToken}` }
            });
            const data = await res.json();

            if (res.ok) {
                showResults(`✅ Tải thành công ${data.length} ảnh của bạn.`);
                renderGallery(data);
            } else {
                showResults(`❌ Lỗi: ${data.msg}`, 'error');
            }
        }

        async function searchByTag() {
            const tag = document.getElementById('tag').value;
            if (!currentToken || !tag) {
                showResults("❌ Lỗi: Vui lòng Nhập tag!", 'error');
                return;
            }
            showResults(`Đang tìm tag '${tag}'...`);
            const res = await fetch(`${API_URL}/api/images/search?tag=${tag}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${currentToken}` }
            });
            const data = await res.json();

            if (res.ok) {
                showResults(`✅ Tìm thấy ${data.length} ảnh với tag '${tag}'.`);
                renderGallery(data);
            } else {
                showResults(`❌ Lỗi: ${data.msg}`, 'error');
            }
        }

        checkLogin();
    </script>
</body>
</html>